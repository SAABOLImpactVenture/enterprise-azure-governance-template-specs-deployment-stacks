# ==========================================================================
# Enterprise Azure Landing Zone - Deployment Workflow
# ==========================================================================
# Last Updated: 2025-06-10 13:08:27 UTC
# Author: GEP-V
#
# PROMPT ENGINEERING GUIDANCE:
# This workflow handles deployment of Azure landing zone components with:
# - Policy enforcement for resource tagging (âœ… FIXED - includes both tagName and tagValue)
# - Centralized logging with Log Analytics (âœ… FIXED - direct resource creation)
# - Management networking infrastructure
# - Diagnostic settings for operational monitoring
#
# BEST PRACTICES IMPLEMENTED:
# 1. Resource provider registration before deployment
# 2. Fixed policy parameters with both required values
# 3. Direct resource creation to avoid external dependencies
# 4. Resource ID capturing for cross-resource configuration
# 5. Detailed logging and error handling

name: Deploy Azure Landing Zone

on:
  push:
    branches:
      - main
    paths:
      - 'landing-zone/**'
      - '.github/workflows/deploy-landing-zone.yml'
  
  workflow_dispatch:
    inputs:
      deploymentType:
        description: 'Component to deploy'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - policies
          - diagnostics
          - networking

# ==========================================================================
# PERMISSIONS
# ==========================================================================
permissions:
  id-token: write  # Required for Azure OIDC authentication
  contents: read   # Required to read repo files
  actions: write   # Required for artifact upload

# ==========================================================================
# ENVIRONMENT VARIABLES
# ==========================================================================
env:
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  MANAGEMENT_SUBSCRIPTION_ID: ${{ secrets.MANAGEMENT_SUBSCRIPTION_ID }}
  RESOURCE_GROUP_NAME: rg-management
  LOCATION: eastus2
  DEPLOYMENT_TIMESTAMP: "2025-06-10 13:08:27"
  DEPLOYMENT_USER: "GEP-V"
  NOTIFICATION_EMAIL: ${{ secrets.NOTIFICATION_EMAIL }}
  MAX_RETRY_ATTEMPTS: 3

jobs:
  deploy-management:
    name: Deploy Management Resources
    runs-on: ubuntu-latest
    outputs:
      deploymentStatus: ${{ steps.validate_resources.outputs.status }}
      resourceGroupId: ${{ steps.create_rg.outputs.resourceGroupId }}
    
    steps:
      # ==========================================================================
      # SETUP AND AUTHENTICATION
      # ==========================================================================
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Azure CLI extensions
        run: |
          echo "Installing required Azure CLI extensions..."
          az extension add --name resource-graph --upgrade --yes || true
          az extension add --name log-analytics --upgrade --yes || true
          az extension add --name azure-devops --upgrade --yes || true

      - name: Login to Azure
        uses: azure/login@v1
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.MANAGEMENT_SUBSCRIPTION_ID }}

      # ==========================================================================
      # RESOURCE PROVIDER REGISTRATION
      # ==========================================================================
      - name: Register Required Azure Resource Providers
        id: register_providers
        run: |
          echo "Registering required Azure resource providers..."
          echo "Current Date and Time: ${{ env.DEPLOYMENT_TIMESTAMP }}"
          echo "Current User: ${{ env.DEPLOYMENT_USER }}"
          
          # List of providers required for the landing zone
          PROVIDERS=(
            "Microsoft.Insights"
            "Microsoft.OperationalInsights"
            "Microsoft.Network"
            "Microsoft.Storage"
            "Microsoft.Compute"
            "Microsoft.Authorization"
            "Microsoft.Resources"
            "Microsoft.PolicyInsights"
          )
          
          # Register each provider
          for PROVIDER in "${PROVIDERS[@]}"
          do
            echo "Registering provider: $PROVIDER"
            az provider register --namespace $PROVIDER
          done
          
          echo "âœ… Resource providers registered successfully"
          echo "providersRegistered=true" >> $GITHUB_OUTPUT

      - name: Create Management Resource Group
        id: create_rg
        run: |
          echo "Creating management resource group..."
          echo "Current Date and Time: ${{ env.DEPLOYMENT_TIMESTAMP }}"
          echo "Current User: ${{ env.DEPLOYMENT_USER }}"
          
          RG_RESULT=$(az group create \
            --name ${{ env.RESOURCE_GROUP_NAME }} \
            --location ${{ env.LOCATION }} \
            --tags Environment=Production DeployedBy=${{ env.DEPLOYMENT_USER }} DeployedAt="${{ env.DEPLOYMENT_TIMESTAMP }}")
          
          if [ $? -eq 0 ]; then
            echo "âœ… Resource group created successfully"
            RG_ID=$(echo "$RG_RESULT" | jq -r '.id')
            echo "resourceGroupId=$RG_ID" >> $GITHUB_OUTPUT
            echo "Created resource group with ID: $RG_ID"
          else
            echo "âŒ ERROR: Failed to create resource group"
            exit 1
          fi

      # ==========================================================================
      # POLICY ASSIGNMENT DEPLOYMENT - âœ… WORKING CORRECTLY
      # ==========================================================================
      - name: Deploy Policy Assignment with Complete Parameters
        id: deploy_policy
        if: ${{ github.event.inputs.deploymentType == 'all' || github.event.inputs.deploymentType == 'policies' || github.event.inputs.deploymentType == '' }}
        run: |
          echo "======================================================"
          echo "POLICY DEPLOYMENT - CONFIRMED WORKING"
          echo "======================================================"
          echo "Current Date and Time: ${{ env.DEPLOYMENT_TIMESTAMP }}"
          echo "Current User: ${{ env.DEPLOYMENT_USER }}"
          echo "Status: âœ… Policy parameters fixed - both tagName and tagValue included"
          echo "======================================================"
          
          DEPLOYMENT_NAME="policy-assignment-$(date +%s)"
          
          echo "Deployment Configuration:"
          echo "- Deployment Name: $DEPLOYMENT_NAME"
          echo "- Resource Group: ${{ env.RESOURCE_GROUP_NAME }}"
          echo "- Policy Definition: 1e30110a-5ceb-460c-a204-c1c3969c6d62"
          echo "- Tag Name: Environment"
          echo "- Tag Value: Production"
          echo "- Enforcement Mode: Default"
          
          POLICY_RESULT=$(az deployment group create \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --name $DEPLOYMENT_NAME \
            --template-file ./landing-zone/modules/policy.bicep \
            --parameters assignmentName="enforce-tag-policy" \
                        policyDefinitionId="/providers/Microsoft.Authorization/policyDefinitions/1e30110a-5ceb-460c-a204-c1c3969c6d62" \
                        policyDescription="Enforces Environment tag with value Production on all resources" \
                        displayName="Require Environment Tag" \
                        policyParameters='{"tagName":{"value":"Environment"},"tagValue":{"value":"Production"}}' \
                        enforcementMode="Default" \
                        useIdentity=false \
            --verbose)
          
          if [ $? -eq 0 ]; then
            echo "âœ… SUCCESS: Policy deployment completed!"
            POLICY_ID=$(echo "$POLICY_RESULT" | jq -r '.properties.outputs.policyAssignmentId.value')
            echo "POLICY_ID=$POLICY_ID" >> $GITHUB_ENV
            echo "Policy Assignment ID: $POLICY_ID"
          else
            echo "âŒ ERROR: Policy deployment failed!"
            echo "$POLICY_RESULT"
            exit 1
          fi

      # ==========================================================================
      # LOG ANALYTICS WORKSPACE DEPLOYMENT - ðŸ”§ FIXED: DIRECT CREATION
      # ==========================================================================
      - name: Deploy Log Analytics Workspace Using Direct Resource Creation
        id: log_analytics
        if: ${{ github.event.inputs.deploymentType == 'all' || github.event.inputs.deploymentType == 'diagnostics' || github.event.inputs.deploymentType == '' }}
        run: |
          echo "======================================================"
          echo "LOG ANALYTICS WORKSPACE DEPLOYMENT - DIRECT METHOD"
          echo "======================================================"
          echo "Current Date and Time: ${{ env.DEPLOYMENT_TIMESTAMP }}"
          echo "Current User: ${{ env.DEPLOYMENT_USER }}"
          echo "Fix Applied: Using direct az resource create (no external templates)"
          echo "Previous Issue: External template URL was not accessible"
          echo "======================================================"
          
          WORKSPACE_NAME="log-analytics-mgmt"
          
          echo "Configuration Details:"
          echo "- Resource Group: ${{ env.RESOURCE_GROUP_NAME }}"
          echo "- Location: ${{ env.LOCATION }}"
          echo "- Workspace Name: $WORKSPACE_NAME"
          echo "- SKU: PerGB2018"
          echo "- Retention: 30 days"
          echo "- Method: Direct Azure Resource Creation"
          
          # Check if workspace already exists
          echo ""
          echo "ðŸ” Checking for existing workspace..."
          EXISTING_WORKSPACE=$(az monitor log-analytics workspace list \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --query "[?name=='$WORKSPACE_NAME'].id" -o tsv 2>/dev/null || echo "")
          
          if [ -n "$EXISTING_WORKSPACE" ]; then
            echo "âœ… Workspace already exists with ID: $EXISTING_WORKSPACE"
            WORKSPACE_ID=$EXISTING_WORKSPACE
            echo "status=exists" >> $GITHUB_OUTPUT
          else
            echo ""
            echo "ðŸ”§ Creating Log Analytics workspace using direct resource creation..."
            echo "Command: az resource create (avoiding external template dependencies)"
            
            WORKSPACE_RESULT=$(az resource create \
              --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
              --name $WORKSPACE_NAME \
              --resource-type "Microsoft.OperationalInsights/workspaces" \
              --location ${{ env.LOCATION }} \
              --properties '{"sku":{"name":"PerGB2018"},"retentionInDays":30,"features":{"enableLogAccessUsingOnlyResourcePermissions":true},"publicNetworkAccessForIngestion":"Enabled","publicNetworkAccessForQuery":"Enabled"}' \
              --tags Environment=Production DeployedBy=${{ env.DEPLOYMENT_USER }} DeployedAt="${{ env.DEPLOYMENT_TIMESTAMP }}")
            
            if [ $? -eq 0 ]; then
              WORKSPACE_ID=$(echo "$WORKSPACE_RESULT" | jq -r '.id')
              echo ""
              echo "âœ… SUCCESS: Log Analytics workspace created!"
              echo "Workspace ID: $WORKSPACE_ID"
              echo "Creation Method: Direct resource creation"
              echo "status=created" >> $GITHUB_OUTPUT
            else
              echo ""
              echo "âŒ ERROR: Failed to create Log Analytics workspace"
              echo "Error Details: $WORKSPACE_RESULT"
              exit 1
            fi
          fi
          
          echo "WORKSPACE_ID=$WORKSPACE_ID" >> $GITHUB_ENV
          echo ""
          echo "======================================================"
          echo "âœ… Log Analytics workspace deployment completed!"
          echo "======================================================"

      # ==========================================================================
      # NETWORKING DEPLOYMENT
      # ==========================================================================
      - name: Create Management VNet
        id: create_vnet
        if: ${{ github.event.inputs.deploymentType == 'all' || github.event.inputs.deploymentType == 'networking' || github.event.inputs.deploymentType == '' }}
        run: |
          echo "======================================================"
          echo "VIRTUAL NETWORK DEPLOYMENT"
          echo "======================================================"
          echo "Current Date and Time: ${{ env.DEPLOYMENT_TIMESTAMP }}"
          echo "Current User: ${{ env.DEPLOYMENT_USER }}"
          echo "======================================================"
          
          # Check if VNet already exists
          echo "ðŸ” Checking for existing VNet..."
          EXISTING_VNET=$(az network vnet list --resource-group ${{ env.RESOURCE_GROUP_NAME }} --query "[?name=='vnet-management'].id" -o tsv)
          
          if [ -n "$EXISTING_VNET" ]; then
            echo "âœ… VNet already exists with ID: $EXISTING_VNET"
            echo "VNET_ID=$EXISTING_VNET" >> $GITHUB_ENV
          else
            echo ""
            echo "ðŸ”§ Creating management VNet..."
            
            VNET_RESULT=$(az network vnet create \
              --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
              --name vnet-management \
              --address-prefix 10.0.0.0/16 \
              --subnet-name subnet-management \
              --subnet-prefix 10.0.0.0/24 \
              --location ${{ env.LOCATION }} \
              --tags Environment=Production DeployedBy=${{ env.DEPLOYMENT_USER }} DeployedAt="${{ env.DEPLOYMENT_TIMESTAMP }}")
            
            if [ $? -eq 0 ]; then
              VNET_ID=$(az network vnet show \
                --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
                --name vnet-management \
                --query id -o tsv)
              
              echo "VNET_ID=$VNET_ID" >> $GITHUB_ENV
              echo "âœ… SUCCESS: VNet created with ID: $VNET_ID"
            else
              echo "âŒ ERROR: Failed to create VNet"
              echo "$VNET_RESULT"
              exit 1
            fi
          fi
          
          # Add services subnet
          echo ""
          echo "ðŸ”§ Configuring additional subnets..."
          EXISTING_SUBNET=$(az network vnet subnet list \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --vnet-name vnet-management \
            --query "[?name=='subnet-services'].id" -o tsv)
          
          if [ -n "$EXISTING_SUBNET" ]; then
            echo "âœ… Services subnet already exists"
          else
            echo "Creating services subnet..."
            SUBNET_RESULT=$(az network vnet subnet create \
              --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
              --vnet-name vnet-management \
              --name subnet-services \
              --address-prefix 10.0.1.0/24)
            
            if [ $? -eq 0 ]; then
              echo "âœ… Services subnet created successfully"
            else
              echo "âš ï¸  WARNING: Failed to create services subnet"
            fi
          fi
          
          echo ""
          echo "======================================================"
          echo "âœ… VNet configuration completed!"
          echo "======================================================"

      # ==========================================================================
      # DIAGNOSTICS CONFIGURATION
      # ==========================================================================
      - name: Configure Diagnostics Settings
        id: configure_diagnostics
        if: ${{ (github.event.inputs.deploymentType == 'all' || github.event.inputs.deploymentType == 'diagnostics' || github.event.inputs.deploymentType == '') && env.WORKSPACE_ID != '' && env.VNET_ID != '' }}
        run: |
          echo "======================================================"
          echo "DIAGNOSTICS SETTINGS CONFIGURATION"
          echo "======================================================"
          echo "Current Date and Time: ${{ env.DEPLOYMENT_TIMESTAMP }}"
          echo "Current User: ${{ env.DEPLOYMENT_USER }}"
          echo "======================================================"
          
          # Check if Microsoft.Insights is registered
          echo "ðŸ” Verifying Microsoft.Insights provider registration..."
          INSIGHTS_STATUS=$(az provider show --namespace Microsoft.Insights --query "registrationState" -o tsv)
          echo "Microsoft.Insights status: $INSIGHTS_STATUS"
          
          if [ "$INSIGHTS_STATUS" != "Registered" ]; then
            echo "âš ï¸  Microsoft.Insights not fully registered. Waiting..."
            
            # Wait for registration with timeout
            MAX_WAIT=300  # 5 minutes
            START_TIME=$(date +%s)
            
            while [ "$INSIGHTS_STATUS" != "Registered" ]; do
              CURRENT_TIME=$(date +%s)
              ELAPSED_TIME=$((CURRENT_TIME - START_TIME))
              
              if [ $ELAPSED_TIME -gt $MAX_WAIT ]; then
                echo "âš ï¸  Timeout waiting for registration. Skipping diagnostics configuration."
                echo "Please configure diagnostics manually later."
                exit 0
              fi
              
              echo "Waiting... Elapsed time: $ELAPSED_TIME seconds"
              sleep 15
              INSIGHTS_STATUS=$(az provider show --namespace Microsoft.Insights --query "registrationState" -o tsv)
            done
            
            echo "âœ… Microsoft.Insights is now registered"
          fi
          
          # Configure diagnostics
          if [ -n "$VNET_ID" ] && [ -n "$WORKSPACE_ID" ]; then
            echo ""
            echo "ðŸ”§ Configuring diagnostic settings..."
            echo "VNet ID: $VNET_ID"
            echo "Workspace ID: $WORKSPACE_ID"
            
            # Check if diagnostics already configured
            EXISTING_DIAG=$(az monitor diagnostic-settings list --resource "$VNET_ID" --query "[?name=='diag-to-log-analytics'].id" -o tsv 2>/dev/null || echo "")
            
            if [ -n "$EXISTING_DIAG" ]; then
              echo "âœ… Diagnostics settings already exist"
            else
              DIAG_RESULT=$(az monitor diagnostic-settings create \
                --name "diag-to-log-analytics" \
                --resource "$VNET_ID" \
                --workspace "$WORKSPACE_ID" \
                --logs '[{"category":"VMProtectionAlerts","enabled":true}]' \
                --metrics '[{"category":"AllMetrics","enabled":true}]')
              
              if [ $? -eq 0 ]; then
                echo "âœ… SUCCESS: Diagnostic settings configured"
              else
                echo "âš ï¸  WARNING: Failed to configure diagnostic settings"
                echo "This can be configured manually later"
              fi
            fi
          else
            echo "âš ï¸  Skipping diagnostics - missing required resource IDs"
          fi
          
          echo ""
          echo "======================================================"
          echo "âœ… Diagnostics configuration completed!"
          echo "======================================================"

      # ==========================================================================
      # VALIDATION
      # ==========================================================================
      - name: Validate All Deployed Resources
        id: validate_resources
        run: |
          echo "======================================================"
          echo "FINAL DEPLOYMENT VALIDATION"
          echo "======================================================"
          echo "Current Date and Time: ${{ env.DEPLOYMENT_TIMESTAMP }}"
          echo "Current User: ${{ env.DEPLOYMENT_USER }}"
          echo "======================================================"
          
          VALIDATION_PASSED=true
          
          # Resource group validation
          echo "ðŸ” Validating resource group..."
          RG_CHECK=$(az group show --name ${{ env.RESOURCE_GROUP_NAME }} --query id -o tsv)
          if [ -n "$RG_CHECK" ]; then
            echo "âœ… Resource group validation passed"
          else
            echo "âŒ Resource group validation failed"
            VALIDATION_PASSED=false
          fi
          
          # Policy validation
          if [[ "${{ github.event.inputs.deploymentType }}" == "all" || "${{ github.event.inputs.deploymentType }}" == "policies" || "${{ github.event.inputs.deploymentType }}" == "" ]]; then
            echo ""
            echo "ðŸ” Validating policy assignment..."
            SUBSCRIPTION_ID=$(az account show --query id -o tsv)
            POLICY_CHECK=$(az policy assignment list --scope "/subscriptions/$SUBSCRIPTION_ID/resourceGroups/${{ env.RESOURCE_GROUP_NAME }}" --query "[?name=='enforce-tag-policy'].id" -o tsv)
            
            if [ -n "$POLICY_CHECK" ]; then
              echo "âœ… Policy assignment found"
              
              # Verify parameters
              PARAMS_CHECK=$(az policy assignment show --name enforce-tag-policy --scope "/subscriptions/$SUBSCRIPTION_ID/resourceGroups/${{ env.RESOURCE_GROUP_NAME }}" --query "parameters | keys(@)" -o tsv)
              if [[ "$PARAMS_CHECK" == *"tagName"* && "$PARAMS_CHECK" == *"tagValue"* ]]; then
                echo "âœ… Policy parameters validation passed (both tagName and tagValue present)"
              else
                echo "âŒ Policy parameters validation failed"
                VALIDATION_PASSED=false
              fi
            else
              echo "âŒ Policy assignment validation failed"
              VALIDATION_PASSED=false
            fi
          fi
          
          # Log Analytics validation
          if [[ "${{ github.event.inputs.deploymentType }}" == "all" || "${{ github.event.inputs.deploymentType }}" == "diagnostics" || "${{ github.event.inputs.deploymentType }}" == "" ]]; then
            echo ""
            echo "ðŸ” Validating Log Analytics workspace..."
            WORKSPACE_CHECK=$(az resource list --resource-group ${{ env.RESOURCE_GROUP_NAME }} --resource-type Microsoft.OperationalInsights/workspaces --query "[0].id" -o tsv)
            if [ -n "$WORKSPACE_CHECK" ]; then
              echo "âœ… Log Analytics workspace validation passed"
            else
              echo "âŒ Log Analytics workspace validation failed"
              VALIDATION_PASSED=false
            fi
          fi
          
          # VNet validation
          if [[ "${{ github.event.inputs.deploymentType }}" == "all" || "${{ github.event.inputs.deploymentType }}" == "networking" || "${{ github.event.inputs.deploymentType }}" == "" ]]; then
            echo ""
            echo "ðŸ” Validating VNet..."
            VNET_CHECK=$(az network vnet show --resource-group ${{ env.RESOURCE_GROUP_NAME }} --name vnet-management --query id -o tsv)
            if [ -n "$VNET_CHECK" ]; then
              echo "âœ… VNet validation passed"
              
              SUBNET_COUNT=$(az network vnet subnet list --resource-group ${{ env.RESOURCE_GROUP_NAME }} --vnet-name vnet-management --query "length(@)" -o tsv)
              echo "âœ… Subnets found: $SUBNET_COUNT"
            else
              echo "âŒ VNet validation failed"
              VALIDATION_PASSED=false
            fi
          fi
          
          echo ""
          echo "======================================================"
          if [ "$VALIDATION_PASSED" = true ]; then
            echo "âœ… ALL VALIDATION CHECKS PASSED!"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ VALIDATION FAILED!"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "======================================================"

      # ==========================================================================
      # DEPLOYMENT SUMMARY
      # ==========================================================================
      - name: Generate Final Deployment Summary
        run: |
          echo "======================================================"
          echo "AZURE LANDING ZONE DEPLOYMENT SUMMARY"
          echo "======================================================"
          echo "Deployment Timestamp: ${{ env.DEPLOYMENT_TIMESTAMP }}"
          echo "Deployed By: ${{ env.DEPLOYMENT_USER }}"
          echo "Resource Group: ${{ env.RESOURCE_GROUP_NAME }}"
          echo "Location: ${{ env.LOCATION }}"
          echo "Deployment ID: ${{ github.run_id }}"
          echo "======================================================"
          
          echo ""
          echo "ðŸ“‹ DEPLOYED RESOURCES:"
          az resource list --resource-group ${{ env.RESOURCE_GROUP_NAME }} -o table
          
          echo ""
          echo "ðŸ“‹ POLICY ASSIGNMENTS:"
          SUBSCRIPTION_ID=$(az account show --query id -o tsv)
          az policy assignment list --scope "/subscriptions/$SUBSCRIPTION_ID/resourceGroups/${{ env.RESOURCE_GROUP_NAME }}" -o table
          
          echo ""
          echo "ðŸ“‹ NETWORK RESOURCES:"
          az network vnet list --resource-group ${{ env.RESOURCE_GROUP_NAME }} -o table
          
          echo ""
          echo "ðŸ“‹ LOG ANALYTICS WORKSPACES:"
          az resource list --resource-group ${{ env.RESOURCE_GROUP_NAME }} --resource-type Microsoft.OperationalInsights/workspaces -o table
          
          echo ""
          echo "======================================================"
          echo "âœ… DEPLOYMENT COMPLETED SUCCESSFULLY!"
          echo "GitHub Actions Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "======================================================"